<!-- templates/people/_tab_import_preview.html -->
<section id="people-section">
  <h2>Import People — Map Columns</h2>

  <form method="post"
        hx-post="{% url 'people_import' %}"
        hx-target="#people-section"
        hx-swap="outerHTML">
    {% csrf_token %}
    <input type="hidden" name="step" value="import">
    <input type="hidden" name="csv_b64" value="{{ csv_b64|escape }}">

    <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      {% for h in headers %}
        <div>
          <label><strong>CSV: “{{ h }}”</strong>
            <select name="map_field_{{ forloop.counter0 }}">
              <option value="">-- skip --</option>
              {% for f in allowed_fields %}
                <option value="{{ f }}" {% if guesses|index:forloop.parentloop.counter0 == f %}selected{% endif %}>{{ f }}</option>
              {% endfor %}
            </select>
          </label>
        </div>
      {% endfor %}
    </div>

    <div class="mt-4">
      <label><input type="checkbox" name="dedupe_by_phone" value="1" checked> Update if same phone exists</label><br>
      <label><input type="checkbox" name="skip_errors" value="1"> Skip rows with errors when committing</label>
    </div>

    <h3 class="mt-4">Preview (first few rows)</h3>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            {% for h in headers %}<th>{{ h }}</th>{% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for r in preview_rows %}
            <tr>
              {% for cell in r %}<td>{{ cell }}</td>{% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-4 flex gap-2">
      <button class="button" name="commit" value="0">Validate Only</button>
      <button class="button primary" name="commit" value="1">Import</button>
      <a class="button" href="{% url 'people_import' %}" hx-get="{% url 'people_import' %}" hx-target="#people-section" hx-swap="outerHTML">Start Over</a>
    </div>
  </form>
</section>
